TYPE
    MAGAZIN_STATES_T : (GREEN_LAMP , INIT , INTERSTEP , MAGAZIN_INIT , MAGAZIN_INIT_2 , SLIDER_MOVE_BACK , START_MAGAZIN , STEP0 , STEP1 , CONVEY);
    CRANE_STATES_T : (CRANE_INIT , CRANE_INIT_2 , CRANE_LIFT_CONVEYOR , CRANE_LIFT_MAGAZINE , CRANE_ON_CONVEYOR , CRANE_STOP , CRANE_TURN_LEFT , INIT , INTERSTEP , INTERSTEP_2 , INTERSTEP_CHECK_WORKPIECE , MAGAZIN_STOP , START_CRANE , TIMEDELAY , TURN_RIGHT , RELEASE);
END_TYPE

FUNCTION_BLOCK MAGAZIN
    VAR_INPUT  CRANEDOWN : BOOL; END_VAR 
    VAR_INPUT  CRANEONCONVEYOR : BOOL; END_VAR 
    VAR_INPUT  CRANEONMAGAZIN : BOOL; END_VAR 
    VAR_INPUT  CRANESUCKED : BOOL; END_VAR 
    VAR_INPUT  CRANEUP : BOOL; END_VAR 
    VAR_OUTPUT  MAGAZINGREENLAMP : BOOL; END_VAR 
    VAR_OUTPUT  MAGAZINSLIDER : BOOL; END_VAR 
    VAR  SFCINIT : BOOL; END_VAR 
    VAR_INPUT  SFCRESET : BOOL; END_VAR 
    VAR_INPUT  SLIDERMOVEDOUT : BOOL; END_VAR 
    VAR_INPUT  SLIDERNOTMOVEDOUT : BOOL; END_VAR 
    VAR_INPUT  STARTBUTTONMAGAZIN : BOOL; END_VAR 
    VAR_OUTPUT  STARTCOMMANDMAGAZIN : BOOL; END_VAR 
    VAR_INPUT  STARTVAR : BOOL; END_VAR 
    VAR_INPUT  WORKPIECEREADY : BOOL; END_VAR 
    VAR  _STATE : MAGAZIN_STATES_T; END_VAR 
    VAR  _TRANSIT : BOOL; END_VAR 
    VAR  INTERCONNECTMAGAZINESTARTCOMMAND : BOOL; END_VAR 
    
    CASE _STATE OF 
        MAGAZIN_STATES_T#GREEN_LAMP:
            _TRANSIT := FALSE;
            MAGAZINGREENLAMP := TRUE;
            INTERCONNECTMAGAZINESTARTCOMMAND := FALSE;
            IF TRUE THEN
                _TRANSIT := TRUE;
                _STATE := MAGAZIN_STATES_T#MAGAZIN_INIT;
            END_IF;
        
        MAGAZIN_STATES_T#INIT:
            _TRANSIT := FALSE;
            IF TRUE THEN
                _TRANSIT := TRUE;
                _STATE := MAGAZIN_STATES_T#START_MAGAZIN;
            END_IF;
        
        MAGAZIN_STATES_T#INTERSTEP:
            _TRANSIT := FALSE;
            STARTCOMMANDMAGAZIN := TRUE;
            IF STARTVAR THEN
                _TRANSIT := TRUE;
                _STATE := MAGAZIN_STATES_T#CONVEY;
            END_IF;
        
        MAGAZIN_STATES_T#MAGAZIN_INIT:
            _TRANSIT := FALSE;
            MAGAZINSLIDER := TRUE;
            IF TRUE THEN
                _TRANSIT := TRUE;
                _STATE := MAGAZIN_STATES_T#MAGAZIN_INIT_2;
            END_IF;
        
        MAGAZIN_STATES_T#MAGAZIN_INIT_2:
            _TRANSIT := FALSE;
            MAGAZINSLIDER := FALSE;
            IF TRUE THEN
                _TRANSIT := TRUE;
                _STATE := MAGAZIN_STATES_T#INTERSTEP;
            END_IF;
        
        MAGAZIN_STATES_T#SLIDER_MOVE_BACK:
            _TRANSIT := FALSE;
            IF ((SLIDERMOVEDOUT = TRUE) AND (SLIDERNOTMOVEDOUT = FALSE)) THEN
                MAGAZINSLIDER := FALSE;
            END_IF;
            IF CRANEUP THEN
                _TRANSIT := TRUE;
                _STATE := MAGAZIN_STATES_T#STEP1;
            END_IF;
        
        MAGAZIN_STATES_T#START_MAGAZIN:
            _TRANSIT := FALSE;
            MAGAZINSLIDER := FALSE;
            MAGAZINGREENLAMP := FALSE;
            STARTVAR := FALSE;
            STARTCOMMANDMAGAZIN := FALSE;
            IF (STARTBUTTONMAGAZIN = TRUE) THEN
                INTERCONNECTMAGAZINESTARTCOMMAND := TRUE;
            END_IF;
            IF INTERCONNECTMAGAZINESTARTCOMMAND THEN
                _TRANSIT := TRUE;
                _STATE := MAGAZIN_STATES_T#GREEN_LAMP;
            END_IF;
        
        MAGAZIN_STATES_T#STEP0:
            _TRANSIT := FALSE;
            IF CRANEDOWN THEN
                _TRANSIT := TRUE;
                _STATE := MAGAZIN_STATES_T#SLIDER_MOVE_BACK;
            END_IF;
        
        MAGAZIN_STATES_T#STEP1:
            _TRANSIT := FALSE;
            IF CRANEONCONVEYOR THEN
                _TRANSIT := TRUE;
                _STATE := MAGAZIN_STATES_T#INTERSTEP;
            END_IF;
        
        MAGAZIN_STATES_T#CONVEY:
            _TRANSIT := FALSE;
            IF SLIDERNOTMOVEDOUT THEN
                MAGAZINSLIDER := TRUE;
            END_IF;
            IF CRANEONMAGAZIN THEN
                _TRANSIT := TRUE;
                _STATE := MAGAZIN_STATES_T#STEP0;
            END_IF;
        
            END_CASE;
END_FUNCTION_BLOCK

FUNCTION_BLOCK CRANE_FB
    VAR_INPUT  CRANEDOWN : BOOL; END_VAR 
    VAR_OUTPUT  CRANELOWER : BOOL; END_VAR 
    VAR_INPUT  CRANEONCONVEYOR : BOOL; END_VAR 
    VAR_INPUT  CRANEONMAGAZIN : BOOL; END_VAR 
    VAR_INPUT  CRANESUCKED : BOOL; END_VAR 
    VAR_OUTPUT  CRANETURNCLOCKWISE : BOOL; END_VAR 
    VAR_OUTPUT  CRANETURNCOUNTERCLOCKWISE : BOOL; END_VAR 
    VAR_INPUT  CRANEUP : BOOL; END_VAR 
    VAR_OUTPUT  MAGAZINVACUUMOFF : BOOL; END_VAR 
    VAR_OUTPUT  MAGAZINVACUUMON : BOOL; END_VAR 
    VAR  SFCINIT : BOOL; END_VAR 
    VAR_INPUT  SFCRESET : BOOL; END_VAR 
    VAR_INPUT  SLIDERMOVEDOUT : BOOL; END_VAR 
    VAR_INPUT  SLIDERNOTMOVEDOUT : BOOL; END_VAR 
    VAR_INPUT  STARTBUTTONMAGAZIN : BOOL; END_VAR 
    VAR_OUTPUT  STARTCOMMANDCRANE : BOOL; END_VAR 
    VAR_INPUT  STARTVAR : BOOL; END_VAR 
    VAR  TIMEDELAY_TIMER : TON; END_VAR 
    VAR  TIMEDELAY_TIMER_DURATION : TIME := TIME#50MS; END_VAR 
    VAR  TIMEDELAY_TIMER_INTERCONNECT : BOOL; END_VAR 
    VAR_INPUT  WORKPIECEREADY : BOOL; END_VAR 
    VAR  _STATE : CRANE_STATES_T; END_VAR 
    VAR  _TRANSIT : BOOL; END_VAR 
    VAR  INTERCONNECTCRANESTARTCOMMAND : BOOL; END_VAR 
    
    CASE _STATE OF 
        CRANE_STATES_T#CRANE_INIT:
            _TRANSIT := FALSE;
            CRANELOWER := TRUE;
            INTERCONNECTCRANESTARTCOMMAND := FALSE;
            IF CRANEDOWN THEN
                _TRANSIT := TRUE;
                _STATE := CRANE_STATES_T#CRANE_INIT_2;
            END_IF;
        
        CRANE_STATES_T#CRANE_INIT_2:
            _TRANSIT := FALSE;
            CRANELOWER := FALSE;
            IF CRANEUP THEN
                _TRANSIT := TRUE;
                _STATE := CRANE_STATES_T#INTERSTEP;
            END_IF;
        
        CRANE_STATES_T#CRANE_LIFT_CONVEYOR:
            _TRANSIT := FALSE;
            CRANELOWER := FALSE;
            IF TRUE THEN
                _TRANSIT := TRUE;
                _STATE := CRANE_STATES_T#INTERSTEP;
            END_IF;
        
        CRANE_STATES_T#CRANE_LIFT_MAGAZINE:
            _TRANSIT := FALSE;
            CRANELOWER := FALSE;
            IF CRANEUP THEN
                _TRANSIT := TRUE;
                _STATE := CRANE_STATES_T#CRANE_TURN_LEFT;
            END_IF;
        
        CRANE_STATES_T#CRANE_ON_CONVEYOR:
            _TRANSIT := FALSE;
            CRANETURNCOUNTERCLOCKWISE := FALSE;
            CRANETURNCLOCKWISE := FALSE;
            CRANELOWER := TRUE;
            IF CRANEDOWN THEN
                _TRANSIT := TRUE;
                _STATE := CRANE_STATES_T#RELEASE;
            END_IF;
        
        CRANE_STATES_T#CRANE_STOP:
            _TRANSIT := FALSE;
            IF TRUE THEN
                _TRANSIT := TRUE;
                _STATE := CRANE_STATES_T#START_CRANE;
            END_IF;
        
        CRANE_STATES_T#CRANE_TURN_LEFT:
            _TRANSIT := FALSE;
            CRANETURNCOUNTERCLOCKWISE := TRUE;
            CRANETURNCLOCKWISE := FALSE;
            IF CRANEONCONVEYOR THEN
                _TRANSIT := TRUE;
                _STATE := CRANE_STATES_T#CRANE_ON_CONVEYOR;
            END_IF;
        
        CRANE_STATES_T#INIT:
            _TRANSIT := FALSE;
            IF TRUE THEN
                _TRANSIT := TRUE;
                _STATE := CRANE_STATES_T#START_CRANE;
            END_IF;
        
        CRANE_STATES_T#INTERSTEP:
            _TRANSIT := FALSE;
            STARTCOMMANDCRANE := TRUE;
            IF STARTVAR THEN
                _TRANSIT := TRUE;
                _STATE := CRANE_STATES_T#INTERSTEP_2;
            END_IF;
        
        CRANE_STATES_T#INTERSTEP_2:
            _TRANSIT := FALSE;
            IF SLIDERMOVEDOUT THEN
                _TRANSIT := TRUE;
                _STATE := CRANE_STATES_T#TIMEDELAY;
            END_IF;
        
        CRANE_STATES_T#INTERSTEP_CHECK_WORKPIECE:
            _TRANSIT := FALSE;
            IF WORKPIECEREADY THEN
                _TRANSIT := TRUE;
                _STATE := CRANE_STATES_T#MAGAZIN_STOP;
            ELSIF NOT WORKPIECEREADY THEN
                _TRANSIT := TRUE;
                _STATE := CRANE_STATES_T#CRANE_STOP;
            END_IF;
        
        CRANE_STATES_T#MAGAZIN_STOP:
            _TRANSIT := FALSE;
            CRANETURNCLOCKWISE := FALSE;
            CRANETURNCOUNTERCLOCKWISE := FALSE;
            MAGAZINVACUUMON := TRUE;
            MAGAZINVACUUMOFF := FALSE;
            CRANELOWER := TRUE;
            IF CRANESUCKED THEN
                _TRANSIT := TRUE;
                _STATE := CRANE_STATES_T#CRANE_LIFT_MAGAZINE;
            END_IF;
        
        CRANE_STATES_T#START_CRANE:
            _TRANSIT := FALSE;
            CRANELOWER := FALSE;
            MAGAZINVACUUMOFF := TRUE;
            MAGAZINVACUUMON := FALSE;
            CRANETURNCOUNTERCLOCKWISE := FALSE;
            CRANETURNCLOCKWISE := FALSE;
            STARTVAR := FALSE;
            STARTCOMMANDCRANE := FALSE;
            IF (STARTBUTTONMAGAZIN = TRUE) THEN
                INTERCONNECTCRANESTARTCOMMAND := TRUE;
            END_IF;
            IF INTERCONNECTCRANESTARTCOMMAND THEN
                _TRANSIT := TRUE;
                _STATE := CRANE_STATES_T#CRANE_INIT;
            END_IF;
        
        CRANE_STATES_T#TIMEDELAY:
            _TRANSIT := FALSE;
            TIMEDELAY_TIMER(IN := TRUE, PT := TIMEDELAY_TIMER_DURATION);
            TIMEDELAY_TIMER_INTERCONNECT := TIMEDELAY_TIMER.Q;
            IF TIMEDELAY_TIMER_INTERCONNECT THEN
                _TRANSIT := TRUE;
                _STATE := CRANE_STATES_T#TURN_RIGHT;
            END_IF;
        
        CRANE_STATES_T#TURN_RIGHT:
            _TRANSIT := FALSE;
            CRANETURNCLOCKWISE := TRUE;
            CRANETURNCOUNTERCLOCKWISE := FALSE;
            IF CRANEONMAGAZIN THEN
                _TRANSIT := TRUE;
                _STATE := CRANE_STATES_T#INTERSTEP_CHECK_WORKPIECE;
            END_IF;
        
        CRANE_STATES_T#RELEASE:
            _TRANSIT := FALSE;
            MAGAZINVACUUMOFF := TRUE;
            MAGAZINVACUUMON := FALSE;
            IF TRUE THEN
                _TRANSIT := TRUE;
                _STATE := CRANE_STATES_T#CRANE_LIFT_CONVEYOR;
            END_IF;
        
            END_CASE;
END_FUNCTION_BLOCK

PROGRAM MAIN

VAR  ACTUATOR_CRANELOWER : BOOL; END_VAR 
VAR  ACTUATOR_CRANETURNCLOCKWISE : BOOL; END_VAR 
VAR  ACTUATOR_CRANETURNCOUNTERCLOCKWISE : BOOL; END_VAR 
VAR  ACTUATOR_MAGAZINGREENLAMP : BOOL; END_VAR 
VAR  ACTUATOR_MAGAZINSLIDER : BOOL; END_VAR 
VAR  ACTUATOR_MAGAZINVACUUMOFF : BOOL; END_VAR 
VAR  ACTUATOR_MAGAZINVACUUMON : BOOL; END_VAR 
VAR  ACTUATOR_MAGAZINWHITELAMP : BOOL; END_VAR 
VAR  CRANE : CRANE_FB; END_VAR 
VAR  MAG : MAGAZIN; END_VAR 
VAR  SENSOR_CRANEDOWN : BOOL; END_VAR 
VAR  SENSOR_CRANEONCONVEYOR : BOOL; END_VAR 
VAR  SENSOR_CRANEONMAGAZIN : BOOL; END_VAR 
VAR  SENSOR_CRANEPOSITION : BOOL; END_VAR 
VAR  SENSOR_CRANESUCKED : BOOL; END_VAR 
VAR  SENSOR_CRANEUP : BOOL; END_VAR 
VAR  SENSOR_MAGAZINEMERGENCYSTOP : BOOL; END_VAR 
VAR  SENSOR_MAGAZINSWITCHMANUELLAUTOMATIC : BOOL; END_VAR 
VAR  SENSOR_SLIDERMOVEDOUT : BOOL; END_VAR 
VAR  SENSOR_SLIDERNOTMOVEDOUT : BOOL; END_VAR 
VAR  SENSOR_STARTBUTTONMAGAZIN : BOOL; END_VAR 
VAR  SENSOR_WORKPIECEREADY : BOOL; END_VAR 
MAG.SLIDERNOTMOVEDOUT := SENSOR_SLIDERNOTMOVEDOUT;
MAG.SLIDERMOVEDOUT := SENSOR_SLIDERMOVEDOUT;
MAG.CRANEONMAGAZIN := SENSOR_CRANEONMAGAZIN;
MAG.CRANEDOWN := SENSOR_CRANEDOWN;
MAG.CRANEUP := SENSOR_CRANEUP;
MAG.CRANEONCONVEYOR := SENSOR_CRANEONCONVEYOR;
MAG.WORKPIECEREADY := SENSOR_WORKPIECEREADY;
MAG.STARTBUTTONMAGAZIN := SENSOR_STARTBUTTONMAGAZIN;
ACTUATOR_MAGAZINSLIDER := MAG.MAGAZINSLIDER;
ACTUATOR_MAGAZINGREENLAMP := MAG.MAGAZINGREENLAMP;
CRANE.WORKPIECEREADY := SENSOR_WORKPIECEREADY;
CRANE.CRANEUP := SENSOR_CRANEUP;
CRANE.CRANEONCONVEYOR := SENSOR_CRANEONCONVEYOR;
CRANE.CRANEDOWN := SENSOR_CRANEDOWN;
CRANE.CRANESUCKED := SENSOR_CRANESUCKED;
CRANE.CRANEONMAGAZIN := SENSOR_CRANEONMAGAZIN;
CRANE.SLIDERMOVEDOUT := SENSOR_SLIDERMOVEDOUT;
CRANE.STARTBUTTONMAGAZIN := SENSOR_STARTBUTTONMAGAZIN;
ACTUATOR_CRANETURNCOUNTERCLOCKWISE := CRANE.CRANETURNCOUNTERCLOCKWISE;
ACTUATOR_CRANETURNCLOCKWISE := CRANE.CRANETURNCLOCKWISE;
ACTUATOR_CRANELOWER := CRANE.CRANELOWER;
ACTUATOR_MAGAZINVACUUMOFF := CRANE.MAGAZINVACUUMOFF;
ACTUATOR_MAGAZINVACUUMON := CRANE.MAGAZINVACUUMON;
IF SENSOR_MAGAZINEMERGENCYSTOP THEN
    MAG();
    CRANE();
    IF ACTUATOR_MAGAZINGREENLAMP THEN
        IF (CRANE.STARTCOMMANDCRANE AND MAG.STARTCOMMANDMAGAZIN) THEN
            CRANE.STARTVAR := TRUE;
            MAG.STARTVAR := TRUE;
        END_IF;
    END_IF;
    CRANE.SFCRESET := FALSE;
    MAG.SFCRESET := FALSE;
ELSIF NOT SENSOR_MAGAZINEMERGENCYSTOP THEN
    ACTUATOR_MAGAZINSLIDER := FALSE;
    ACTUATOR_CRANELOWER := FALSE;
    ACTUATOR_MAGAZINVACUUMON := FALSE;
    ACTUATOR_MAGAZINVACUUMOFF := TRUE;
    ACTUATOR_MAGAZINGREENLAMP := FALSE;
    ACTUATOR_CRANETURNCOUNTERCLOCKWISE := FALSE;
    ACTUATOR_CRANETURNCLOCKWISE := FALSE;
    CRANE.SFCRESET := TRUE;
    MAG.SFCRESET := TRUE;
    CRANE.STARTVAR := FALSE;
    MAG.STARTVAR := FALSE;
END_IF;
END_PROGRAM


CONFIGURATION Config0
  RESOURCE Res0 ON PLC
    TASK TASK0(INTERVAL := T#50MS, PRIORITY := 0);
    PROGRAM INSTANCE0 WITH TASK0 : MAIN;
  END_RESOURCE
END_CONFIGURATION
